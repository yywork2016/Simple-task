/* PhotoClip v2.0.5 | Relying on the plug-in [jquery.js] [iscroll-zoom.js] [hammer.js] [lrz.all.bundle.js] */
!function(o,t){"use strict";"function"==typeof define&&define.amd?define(["jquery","iscroll-zoom","hammer","lrz"],t):"object"==typeof exports?module.exports=t(require("jquery"),require("iscroll-zoom"),require("hammer"),require("lrz")):o.PhotoClip=t(o.jQuery,o.IScroll,o.Hammer,o.lrz)}(this,function(o,t,e,n){"use strict";function i(t,e){var n=o.extend({},l,e);a.call(this,t,n)}function a(i,a){function u(){dt=!0,vt.append(this),k(lt,function(){ct=this.naturalWidth,ut=this.naturalHeight},this),k(mt,function(){f()}),$.call(W,this)}function p(){var o={zoom:!0,scrollX:!0,scrollY:!0,freeScroll:!0,mouseWheel:!0,wheelAction:"zoom"};jt=new t(gt[0],o)}function f(){Rt=0,Et=0,It=0,pt=ct,ft=ut,vt.css({width:ct,height:ut}),C(vt,Rt,Et,It),d(ct,ut),jt.zoom(jt.options.zoomStart);var o=.5*(ot-ct*jt.scale),t=.5*(tt-ut*jt.scale);jt.scrollTo(o,t)}function d(o,t){F(o,t),jt.scale<jt.options.zoomMin&&jt.zoom(jt.options.zoomMin),mt.css({width:o,height:t}),gt.append(mt),jt.refresh()}function h(){if(s){Ft=new e.Manager(mt[0]),Ft.add(new e.Rotate);var o,t;Ft.on("rotatemove",function(e){At||(o=e.rotation,o>180?o-=360:-180>o&&(o+=360),t=o>0?1:0>o?-1:0)}),Ft.on("rotateend",function(e){At||Math.abs(o)>30&&(1==t?g(e.center):-1==t&&m(e.center))})}else mt.on("dblclick",function(o){g({x:o.clientX,y:o.clientY})})}function g(o){v(90,o)}function m(o){v(-90,o)}function v(o,t){if(!At){At=!0;var e;e=t?w(mt,t.x,t.y):z(mt,gt,.5*ot,.5*tt);var n=T(It,e),i=n.x,a=n.y,r=0,s=0,l=0,c=0,u=It+o;90==u||-270==u?(r=i+a,s=a-i,u>It?(l=ut-i-a,c=i-a):It>u&&(l=ut-a-(ct-i),c=i+a-ut),pt=ut,ft=ct):180==u||-180==u?(r=2*i,s=2*a,u>It?(l=ct-i-(ut-a),c=ut-(i+a)):It>u&&(l=ct-(i+a),c=ut-a-(ct-i)),pt=ct,ft=ut):270==u||-90==u?(r=i-a,s=i+a,u>It?(l=i+a-ct,c=ct-i-(ut-a)):It>u&&(l=a-i,c=ct-i-a),pt=ut,ft=ct):(0==u||360==u||-360==u)&&(r=0,s=0,u>It?(l=i-a,c=i+a-ct):It>u&&(l=i+a-ut,c=a-i),pt=ct,ft=ut),0==It?(Rt=0,Et=0):90==It||-270==It?(Rt-=i+a,Et-=a-i):180==It||-180==It?(Rt-=2*i,Et-=2*a):(270==It||-90==It)&&(Rt-=i-a,Et-=i+a),Rt=Rt.toFixed(2)-0,Et=Et.toFixed(2)-0,C(vt,Rt,Et,It,i,a),L(vt,Rt,Et,u,200,function(){At=!1,It=u%360,Rt+=r+l,Et+=s+c,Rt=Rt.toFixed(2)-0,Et=Et.toFixed(2)-0,C(vt,Rt,Et,It),jt.scrollTo(jt.x-l*jt.scale,jt.y-c*jt.scale),d(pt,ft)})}}function b(){Mt=document.createElement("canvas")}function y(){if(!dt)return console.log("当前没有图片可以裁剪!"),void J.call(W,null);var o=z(mt,gt),t=jt.scale,e=Mt.getContext("2d");e.clearRect(0,0,Mt.width,Mt.height),e.save(),it&&at?(Mt.width=it,Mt.height=at,e.scale(it/ot*t,at/tt*t)):(Mt.width=ot/t,Mt.height=tt/t),e.translate(Rt-o.x/t,Et-o.y/t),e.rotate(It*Math.PI/180),e.drawImage(lt[0],0,0),e.restore();try{var n=Mt.toDataURL(O,B);bt.css("background-image","url("+n+")"),J.call(W,n)}catch(i){throw new Error("截图失败！当前图片源文件可能存在跨域问题，请确保图片与应用同源。如果您是在本地环境下执行本程序，请更换至服务器环境。")}}function x(){R()}function z(o,t,e,n){e=e||0,n=n||0;var i,a;return k(o,function(){i=o.offset()}),k(t,function(){a=t.offset()}),{x:a.left-i.left+e,y:a.top-i.top+n}}function w(o,t,e){t=t||0,e=e||0;var n;return k(o,function(){n=o.offset()}),{x:t+qt.scrollLeft()-n.left,y:e+qt.scrollTop()-n.top}}function k(t,e,n){var i=o();o.each(t,function(t,e){for(var n,a=e instanceof jQuery?e:o(e),r=a.parents().addBack().filter(":hidden"),t=r.length;t--&&a.is(":hidden");)n=r.eq(t),"none"===n.css("display")&&(i=i.add(n.show()))}),"function"==typeof e&&e.call(n||this),i.hide()}function T(o,t){var e=jt.scale,n={};return 0==o?(n.x=t.x/e,n.y=t.y/e):90==o||-270==o?(n.x=t.y/e,n.y=ut-t.x/e):180==o||-180==o?(n.x=ct-t.x/e,n.y=ut-t.y/e):(270==o||-90==o)&&(n.x=ct-t.y/e,n.y=t.x/e),n}function M(o,t,e,n){var i=o/e,a=t/n;return i>a?i:a}function F(o,t){jt.options.zoomMin=M(ot,tt,o,t),jt.options.zoomMax=Math.max(1,jt.options.zoomMin),jt.options.zoomStart=Math.min(jt.options.zoomMax,M(St,Ct,o,t))}function j(){lt&&lt.length&&(lt.off(),lt.remove(),delete lt[0])}function S(t){j(),lt=o("<img>").css({"user-select":"none","pointer-events":"none"}),rt||(rt=!0,Z.call(W,lt[0])),lt.on("load",u),lt.attr("src",t)}function C(o,t,e,n,i,a){i=i||0,a=a||0;var r={};r[c+"transform"]="translateZ(0) translate("+t+"px,"+e+"px) rotate("+n+"deg)",r[c+"transform-origin"]=i+"px "+a+"px",o.css(r)}function L(o,t,e,n,i,a){o.css(c+"transform"),o.css(c+"transition",c+"transform "+i+"ms"),o.one(r,function(){o.css(c+"transition",""),a.call(this)}),o.css(c+"transform","translateZ(0) translate("+t+"px,"+e+"px) rotate("+n+"deg)")}function q(o){var t=o+"";return/%$/.test(t)}function A(){ht=o(i).css({"user-select":"none",overflow:"hidden"}),"static"==ht.css("position")&&ht.css("position","relative"),gt=o('<div class="photo-clip-view">').css({position:"absolute",left:"50%",top:"50%"}).appendTo(ht),mt=o('<div class="photo-clip-moveLayer">').appendTo(gt),vt=o('<div class="photo-clip-rotateLayer">').appendTo(mt);var t=o('<div class="photo-clip-mask">').css({position:"absolute",left:0,top:0,width:"100%",height:"100%","pointer-events":"none"}).appendTo(ht);yt=o('<div class="photo-clip-mask-left">').css({position:"absolute",left:0,right:"50%",top:"50%",bottom:"50%",width:"auto","background-color":"rgba(0,0,0,.5)"}).appendTo(t),xt=o('<div class="photo-clip-mask-right">').css({position:"absolute",left:"50%",right:0,top:"50%",bottom:"50%","background-color":"rgba(0,0,0,.5)"}).appendTo(t),zt=o('<div class="photo-clip-mask-top">').css({position:"absolute",left:0,right:0,top:0,bottom:"50%","background-color":"rgba(0,0,0,.5)"}).appendTo(t),wt=o('<div class="photo-clip-mask-bottom">').css({position:"absolute",left:0,right:0,top:"50%",bottom:0,"background-color":"rgba(0,0,0,.5)"}).appendTo(t),Tt=o('<div class="photo-clip-area">').css({border:"1px dashed #ddd",position:"absolute",left:"50%",top:"50%"}).appendTo(t),bt=o(X),bt.length&&bt.css({"background-color":"#666","background-repeat":"no-repeat","background-position":"center","background-size":"contain"})}function R(o,t){var e=et,n=nt;if("number"==typeof o&&(et=o),"number"==typeof t&&(nt=t),ot=et,tt=nt,(N||V)&&(_=et/nt),k(ht,function(){St=ht.width(),Ct=ht.height()}),N&&(ot=St/100*parseFloat(N),V||(tt=ot/_)),V&&(tt=Ct/100*parseFloat(V),N||(ot=tt*_)),gt.css({width:ot,height:tt,"margin-left":-ot/2,"margin-top":-tt/2}),yt.css({"margin-right":ot/2,"margin-top":-tt/2,"margin-bottom":-tt/2}),xt.css({"margin-left":ot/2,"margin-top":-tt/2,"margin-bottom":-tt/2}),zt.css({"margin-bottom":tt/2}),wt.css({"margin-top":tt/2}),Tt.css({width:ot,height:tt,"margin-left":-ot/2-1,"margin-top":-tt/2-1}),pt&&ft){var i=(ot-e)/2*jt.scale,a=(tt-n)/2*jt.scale;jt.scrollBy(i,a),d(pt,ft)}}function E(o){S(o)}function I(){st.off("change"),st=null,Lt.off("click"),Lt=null,Ft?(Ft.off("rotatemove"),Ft.off("rotateend"),Ft.destroy(),Ft=null):mt.off("dblclick"),jt.destroy(),jt=null,ht.empty(),ht=null,gt=null,mt=null,vt=null,yt=null,xt=null,zt=null,wt=null,kt=null,Tt=null,bt.css({"background-color":"","background-repeat":"","background-position":"","background-size":""}),bt=null,lt=null,Mt=null}var W=this,P=a.size,Q=a.adaptive,H=a.outputSize,O=a.outputType||"image/jpeg",B=a.outputQuality,D=a.file,U=a.source,X=a.view,Y=a.ok,Z=a.loadStart,$=a.loadComplete,G=a.loadError,J=a.clipFinish,K=a.lrzOption;o.isArray(P)||(P=l.size),o.isArray(H)||(H=l.outputSize);var N,V,_,ot,tt,et=P[0]||l.size[0],nt=P[1]||l.size[1],it=Math.max(H[0],0),at=Math.max(H[1],0);o.isArray(Q)&&(Q[0]&&(N=q(Q[0])?Q[0]:!1),Q[1]&&(V=q(Q[1])?Q[1]:!1)),"jpg"===O?O="image/jpeg":"png"===O&&(O="image/png");var rt=!1;if(D)if(window.FileReader){var st=o(D);st.length&&(s||st.attr("accept","image/jpeg, image/x-png, image/gif"),st.on("change",function(){if(this.files.length){var o=this.files[0];if(!/image\/\w+/.test(o.type))return console.log("图片格式不正确，请选择正确格式的图片文件！"),G.call(W,"Image format error"),!1;rt||(rt=!0,Z.call(W,o));var t=new FileReader;t.onprogress=function(o){console.log((o.loaded/o.total*100).toFixed()+"%")},t.onload=function(){n(o,K).then(function(o){S(o.base64),rt=!1}).catch(function(o){console.log("图片处理失败"),G.call(W,o),rt=!1})},t.onerror=function(o){console.log("图片加载失败"),G.call(W,o),rt=!1},t.readAsDataURL(o)}}),st.click(function(){this.value=""}))}else alert("您的浏览器不支持 HTML5 的 FileReader API，因此不能使用 file 控件上传图片！");U&&E(U);var lt,ct,ut,pt,ft,dt,ht,gt,mt,vt,bt,yt,xt,zt,wt,kt,Tt,Mt,Ft,jt,St,Ct;A(),p(),h(),b();var Lt=o(Y);Lt.length&&Lt.on("click",function(){y()});var qt=o(window);x(),qt.resize(x);var At,Rt,Et,It;W.setSize=R,W.setImg=E,W.rotateCW=g,W.rotateCCW=m,W.destroy=I}var r,s=!!navigator.userAgent.match(/mobile/i),l={size:[260,260],adaptive:null,outputSize:[0,0],outputType:"jpg",outputQuality:.8,file:"",source:"",view:"",ok:"",loadStart:function(){},loadComplete:function(){},loadError:function(){},clipFinish:function(){},lrzOption:{}},c="";return function(){var o,t={Webkit:"webkit",Moz:"",O:"o"},e=document.documentElement,n=function(t){return o?o+t:t.toLowerCase()};for(var i in t)if(void 0!==e.style[i+"TransitionProperty"]){c="-"+i.toLowerCase()+"-",o=t[i];break}r=n("TransitionEnd")}(),i});